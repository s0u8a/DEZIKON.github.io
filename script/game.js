ã†ã•ã
bright_kitten_72388
ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã‚’éš ã™

ã†ã•ã â€” 2025/05/16 22:32
ã‚³ã‚¢æ©Ÿèƒ½ãƒ»è©³ç´°
éŸ³ã‚²ãƒ¼ã‚·ã‚¹ãƒ†ãƒ 

ç›´æ„Ÿçš„ãªã‚¿ãƒƒãƒ—æ“ä½œï¼ˆ2ãƒ¬ãƒ¼ãƒ³ã€œ4ãƒ¬ãƒ¼ãƒ³åˆ‡æ›¿å¯ï¼‰

é›£æ˜“åº¦é¸æŠï¼ã‚ªãƒ¼ãƒˆæ¼”å¥ã‚ã‚Š

ã‚ªãƒªã‚¸ãƒŠãƒ«æ¥½æ›²ï¼‹ç¾å°‘å¥³ãŸã¡ã®ãƒœãƒ¼ã‚«ãƒ«æ›²å¤šæ•°åéŒ²

ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è‚²æˆãƒ»äº¤æµè¦ç´ 

çµ†ãƒã‚¤ãƒ³ãƒˆã§è§£æ”¾ã•ã‚Œã‚‹ãƒœã‚¤ã‚¹ãƒ»ã‚¤ãƒ©ã‚¹ãƒˆãƒ»ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰

ãŠæ°—ã«å…¥ã‚Šã‚­ãƒ£ãƒ©ã«ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã—ã¦å¥½æ„Ÿåº¦UP

ãƒ•ãƒ«ãƒœã‚¤ã‚¹ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰

è±ªè¯å£°å„ªé™£ã«ã‚ˆã‚‹æ¼”æŠ€

æ¼”å¥ã‚¹ã‚³ã‚¢ã§ãƒ«ãƒ¼ãƒˆåˆ†å²ã€ãƒãƒ«ãƒã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°å¯¾å¿œ

ã‚¤ãƒ™ãƒ³ãƒˆï¼ã‚¬ãƒãƒ£æ©Ÿèƒ½

æ¯æœˆã‚­ãƒ£ãƒ©åˆ¥æ¥½æ›²ã‚¤ãƒ™ãƒ³ãƒˆã‚’é–‹å‚¬

æ–°ã‚­ãƒ£ãƒ©ã¯ã‚¬ãƒãƒ£ã§å…¥æ‰‹ã€è¡£è£…ã‚„æ¼”å‡ºã‚‚å¤‰åŒ–

ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼
éŸ³ã‚²ãƒ¼åˆå¿ƒè€…ï½ä¸­ç´šè€…

ç¾å°‘å¥³ã‚²ãƒ¼ãƒ ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è‚²æˆãŒå¥½ããªãƒ¦ãƒ¼ã‚¶ãƒ¼

éŸ³æ¥½Ã—ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã§æ²¡å…¥ã—ãŸã„å±¤

ã€Œæ¨ã—ã€ã¨ã®æ²¡å…¥æ„Ÿã‚’æ±‚ã‚ã‚‹10ã€œ30ä»£

è§£æ±ºã™ã‚‹èª²é¡Œ
å˜ãªã‚‹éŸ³ã‚²ãƒ¼ã«é£½ããŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã€Œç‰©èªæ€§ã€ã‚’åŠ ãˆã¦ãƒªãƒ†ãƒ³ã‚·ãƒ§ãƒ³ã‚’é«˜ã‚ã‚‹

æ¨ã—ã‚­ãƒ£ãƒ©ã¨æ·±ãäº¤æµã§ãã‚‹ä½“é¨“ã§ã€èª²é‡‘ç‡ãƒ»ç¶™ç¶šç‡ã‚’å‘ä¸Š

éŸ³ã‚²ãƒ¼æœªçµŒé¨“å±¤ã§ã‚‚å…¥ã‚Šã‚„ã™ã„é›£æ˜“åº¦è¨­è¨ˆã§è£¾é‡ã‚’åºƒã’ã‚‹

é–‹ç™ºãƒ„ãƒ¼ãƒ«ãƒ»æŠ€è¡“
ä½¿ç”¨è¨€èªï¼šUnity (C#), Firebase, TypeScriptï¼ˆWebç®¡ç†ç”»é¢ï¼‰

ãƒªã‚ºãƒ è§£æï¼šè‡ªå‹•ãƒãƒ¼ãƒ„ç”Ÿæˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼šGoogle Cloud Functions / Firestore

é–‹ç™ºç’°å¢ƒï¼šUnity Hub, GitHub, Trello, Figmaï¼ˆUIè¨­è¨ˆï¼‰
ã†ã•ã â€” 2025/06/19 15:30
ç”»åƒ
ç”»åƒ
ç”»åƒ
ç”»åƒ
ã†ã•ã â€” 2025/06/24 14:07
https://chatgpt.com/share/685a328b-d050-8006-8f87-526ee2864b34
ChatGPT
ChatGPT - WEBã‚µãƒ¼ãƒæ§‹ç¯‰æ‰‹é †
Shared via ChatGPT
ç”»åƒ
ã†ã•ã â€” 2025/08/26 23:38
ã‚¢ãƒ‹ãƒ¡ã‚¹ã‚¿ã‚¤ãƒ«ã®å°‘å¹´ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€‚ç™½ãã¦ãã—ã‚ƒãã—ã‚ƒã®é«ªã€é‹­ãå†·ãŸã„é’ã„ç›®ã‚’æŒã¤ã€‚æœè£…ã¯é»’ã®ãƒ‘ãƒ¼ã‚«ãƒ¼ã«å¤‰æ›´ã•ã‚Œã¦ãŠã‚Šã€ãã®ä¸‹ã«ã¯ãƒ™ã‚¹ãƒˆã‚·ãƒ£ãƒ„ã‚’ç€ã¦ã„ã‚‹ã€‚ã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥ã§å°‘ã—åæŠ—çš„ãªå°è±¡ã‚’ä¸ãˆã‚‹ã€‚ãƒãƒ³ãƒˆã¯ç„¡ã—ã€‚ç‰‡æ‰‹ã«éŠ€è‰²ã®å‰£ã‚’æ§‹ãˆã€è‡ªä¿¡ã«æº€ã¡ãŸãƒãƒ¼ã‚ºã‚’å–ã£ã¦ã„ã‚‹ã€‚èƒŒæ™¯ã¯ã²ã³å‰²ã‚ŒãŸè’ã‚Œåœ°ã¨ç“¦ç¤«ãŒåºƒãŒã‚Šã€é¢¨ãŒå¹ãè’ã‚Œã‚‹ãƒ€ãƒ¼ã‚¯ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼é¢¨ã®ä¸–ç•Œã€‚å…¨ä½“ã¯ãƒ•ãƒ«ã‚«ãƒ©ãƒ¼ã§ã€é«˜ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã€ã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥ã‹ã¤è¿«åŠ›ã®ã‚ã‚‹ã‚¢ãƒ‹ãƒ¡ã‚¢ãƒ¼ãƒˆã€‚æ–‡è±ªã‚¹ãƒˆãƒ¬ã‚¤ãƒ‰ãƒƒã‚°ã‚¹ã‚„ãƒ€ãƒ¼ã‚¯ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ä½œå“ã«ã‚¤ãƒ³ã‚¹ãƒ‘ã‚¤ã‚¢ã•ã‚ŒãŸãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã€‚
20ä»£å‰åŠã®ç™½é«ªã§ç´«ã®ç›®ã®é’å¹´ã§ã€å†·é™æ²ˆç€ã‹ã¤æ„Ÿæƒ…ã‚’ã‚ã¾ã‚Šè¡¨ã«å‡ºã•ãªã„æ€§æ ¼ã‚’æŒã¤ã€‚å¸¸ã«çŠ¶æ³ã‚’ä¿¯ç°ã—ã¦åˆ¤æ–­ã™ã‚‹æ€æ…®æ·±ã„äººç‰©ã§ã‚ã‚Šã€éƒ½ä¼šã®å–§é¨’ã®ä¸­ã§ã‚‚é™ã‹ã«å­˜åœ¨æ„Ÿã‚’æ”¾ã¤ãƒŸã‚¹ãƒ†ãƒªã‚¢ã‚¹ãªé›°å›²æ°—ã‚’çºã£ã¦ã„ã‚‹ã€‚æœè£…ã¯è½ã¡ç€ã„ãŸè‰²åˆã„ã§çµ±ä¸€ã•ã‚Œã¦ãŠã‚Šã€ç™½ã¨é»’ã®æ ¼å­æŸ„ã®å¤§ããªãƒãƒ•ãƒ©ãƒ¼ã‚’é¦–ã«å·»ãã€ç·‘ã¨ç™½ã®ãƒ€ã‚¤ãƒ¤æŸ„ãŒå…¥ã£ãŸã‚»ãƒ¼ã‚¿ãƒ¼ã®ä¸Šã«é»’ã„ãƒ™ã‚¹ãƒˆã‚’ç¾½ç¹”ã£ã¦ã„ã‚‹ã€‚ç´°èº«ã®é»’ã„ã‚ºãƒœãƒ³ã¨é»’ã„ãƒ–ãƒ¼ãƒ„ã‚’èº«ã«ç€ã‘ã€å³æ‰‹é¦–ã«ã¯éŠ€è‰²ã®ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆãŒè¼ãã€‚å…¨ä½“çš„ã«ãƒ¢ãƒãƒˆãƒ¼ãƒ³ã¨æ·±ç·‘ã‚’åŸºèª¿ã¨ã—ãŸé…è‰²ã§ã€æ§ãˆã‚ãªãŒã‚‰ã‚‚å°è±¡çš„ãªã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã—ã¦ã„ã‚‹ã€‚
ã†ã•ã â€” 2025/08/27 18:39
4146931505096951
ã†ã•ã â€” 2025/08/29 17:53
// index.js
require('dotenv').config();
const express = require('express');
const line = require('@line/bot-sdk');
const { createClient } = require('@supabase/supabase-js');
const cron = require('node-cron');
å±•é–‹
message.txt
15 KB
ã†ã•ã â€” 2025/09/03 15:20
// -----------------------------
// å®šæ•°ãƒ»åˆæœŸè¨­å®š
// -----------------------------
let TILE = window.GMAP?.tile ?? 64;
let GRID = window.GMAP?.grid ?? [];
let ROWS = GRID.length;
å±•é–‹
message.txt
7 KB
ã†ã•ã â€” 2025/09/04 10:48
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<link rel="stylesheet" href="./css/style.css" />
<title>ğŸŒ¾ æ–°æ½ŸRPG ãƒ‡ãƒ¢ç‰ˆ</title>
</head>
<body>
<h1>ğŸŒ¸ æ–°æ½ŸRPG ãƒ‡ãƒ¢ç‰ˆ</h1>
<p>çŸ¢å°ã‚­ãƒ¼ã§ç§»å‹•ã§ãã¾ã™ã€‚æ•µã«ã¶ã¤ã‹ã‚‹ã¨ã‚¯ã‚¤ã‚ºãŒå‡ºã¾ã™ã€‚</p>
 
  <canvas id="gameCanvas"></canvas>
<div id="status" aria-live="polite"></div>
 
  <!-- éãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã€‚å¿…ãš map.js â†’ main.js ã®é †ã§ã€ä¸¡æ–¹ã¨ã‚‚ defer -->
<script src="script/map.js" defer></script>
<script src="script/main.js" defer></script>
 
</body>
</html>
// script/map.js
// 20åˆ— Ã— 15è¡Œ ãƒãƒƒãƒ—
window.GMAP = {
  tile: 64,
  grid: [
    ['#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'],
    ['#','S','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','#'],
    ['#','0','#','0','#','0','#','0','#','0','#','0','#','0','#','0','#','0','#','#'],
    ['#','E','#','0','#','0','#','0','#','0','#','0','#','0','#','0','#','0','#','#'],
    ['#','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','#'],
    ['#','0','#','#','#','#','#','0','#','#','#','#','#','#','#','0','#','#','#','#'],
    ['#','0','#','0','0','0','#','0','#','0','0','0','#','0','#','0','0','0','#','#'],
    ['#','0','#','0','#','0','#','0','#','0','#','0','#','0','#','0','#','0','#','#'],
    ['#','0','#','0','#','0','#','0','#','0','#','0','#','0','#','0','#','0','#','#'],
    ['#','0','0','0','0','0','0','0','0','I','0','0','0','0','0','0','0','0','0','#'],
    ['#','0','#','0','#','0','#','0','#','0','#','0','#','0','#','0','#','0','#','#'],
    ['#','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','#'],
    ['#','0','#','0','#','0','#','0','#','0','#','0','#','0','#','0','#','0','#','#'],
    ['#','0','0','0','0','0','0','0','A','0','0','0','0','0','0','0','0','0','G','#'],
    ['#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'],
  ]
};
// -----------------------------
// å®šæ•°ãƒ»åˆæœŸè¨­å®š
// -----------------------------
let TILE = window.GMAP?.tile ?? 64;
let GRID = window.GMAP?.grid ?? [];
let ROWS = GRID.length;
å±•é–‹
message.txt
8 KB
body {
  font-family: sans-serif;
  background: #222;
  color: #fff;
  text-align: center;
}

#game {
  display: inline-block;
  margin-top: 20px;
}

.row {
  display: flex;
}

.tile {
  width: 64px;   /* TILE ã«åˆã‚ã›ã‚‹ /
  height: 64px;
  border: 1px solid #333;
  background-size: cover;  / ç”»åƒã‚’æ ã„ã£ã±ã„ã«æ•·ãè©°ã‚ã‚‹ /
}

/ ã‚¿ã‚¤ãƒ«ã”ã¨ã«ç”»åƒã‚’å‰²ã‚Šå½“ã¦ */
.tile.floor  { background-image: url("./assets/images/tanbo.png"); }
.tile.wall   { background-image: url("./assets/images/wall.png"); }
.tile.player { background-image: url("./assets/images/noumin.png"); }
.tile.enemy  { background-image: url("./assets/images/enemy.png"); }
.tile.item   { background-image: url("./assets/images/item.png"); }
.tile.ally   { background-image: url("./assets/images/ally.png"); }
.tile.goal   { background-image: url("./assets/images/goal.png"); }
ã†ã•ã â€” 2025/09/04 12:29
ç”»åƒ
ã†ã•ã â€” 11:34
import { maps, tile } from "./map.js";
import { player, initPlayer, takeDamage, updatePlayer, drawLifeGauge, heal } from "./player.js";
import { initEnemies, updateEnemies, drawEnemies, removeEnemy, enemies } from "./enemy.js";
import { checkGoal, checkGameOver } from "./ending.js";
import { startEggGame } from "./eggGame.js";
import { startFishingGame } from "./fishingGame.js";
import { startNiigataQuiz } from "./niigataquiz.js";          // ğŸ¸ ã‚«ã‚¨ãƒ«ç”¨
import { startNiigataHardQuiz } from "./startNiigataHardQuiz.js"; // ğŸ¦ ã‚¢ãƒ©ã‚¤ã‚°ãƒç”¨

// ğŸ® ã‚­ãƒ£ãƒ³ãƒã‚¹è¨­å®š
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
ctx.imageSmoothingEnabled = false;

// ğŸ“¢ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
const statusEl = document.getElementById("messageBox");
function setStatus(msg) {
  if (statusEl) statusEl.textContent = msg;
  console.log(msg);
}

// ğŸµ BGM
const bgm = document.getElementById("bgm");

// ğŸ¨ ç”»åƒç®¡ç†
const images = {
  floor: new Image(),
  wall: new Image(),
  wallSpecial: new Image(),
  enemy: new Image(),
  enemy2: new Image(),
  enemy3: new Image(), // ã‚¢ãƒ©ã‚¤ã‚°ãƒ
  item: new Image(),
  ally: new Image(),
  allyFishing: new Image(),
  goal: new Image(),
  goalEntrance: new Image(),
  entrance: new Image(),
  mahouzin: new Image(),
  floorSpecial: new Image(),
  pl: new Image(),
  heart: new Image(),
  bridge: new Image(),
  tree: new Image(),
  clear: new Image(),
  over: new Image(),
  sadometu: new Image()
};

// ğŸ–¼ ç”»åƒèª­ã¿è¾¼ã¿
images.floor.src = "./assets/images/tanbo3.png";
images.wall.src = "./assets/images/mizu_big.png";
images.wallSpecial.src = "./assets/images/isikabe.png";
images.enemy.src = "./assets/images/enemy.png";
images.enemy2.src = "./assets/images/kaeru.png";
images.enemy3.src = "./assets/images/araiguma.png"; // ğŸ¦ ã‚¢ãƒ©ã‚¤ã‚°ãƒ
images.item.src = "./assets/images/komebukuro.png";
images.ally.src = "./assets/images/murabitopng.png";
images.allyFishing.src = "./assets/images/turibito.png";
images.goal.src = "./assets/images/kakasi2.png";
images.goalEntrance.src = "./assets/images/koudouiriguti.png";
images.entrance.src = "./assets/images/kintin.png";
images.mahouzin.src = "./assets/images/mahouzin.png";
images.floorSpecial.src = "./assets/images/tikakoudouyuka.png";
images.pl.src = "./assets/images/noumin.png";
images.heart.src = "./assets/images/ha-to.png";
images.bridge.src = "./assets/images/hasihasii.png";
images.tree.src = "./assets/images/kinokabe.png";
images.clear.src = "./assets/images/clear.png";
images.over.src = "./assets/images/over.png";
images.sadometu.src = "./assets/images/sadometu.png";

// ğŸŒ ã‚²ãƒ¼ãƒ çŠ¶æ…‹
let currentMapIndex = 0;
let map = maps[currentMapIndex].map(row => [...row]);
let nearAlly = false;
let nearFishingAlly = false;
let gameCleared = false;
let gameOver = false;

// ğŸ–¼ ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒªã‚µã‚¤ã‚º
const dpr = window.devicePixelRatio || 1;
function resizeCanvas() {
  canvas.width = map[0].length * tile * dpr;
  canvas.height = map.length * tile * dpr;
  canvas.style.width = map[0].length * tile + "px";
  canvas.style.height = map.length * tile + "px";
  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.scale(dpr, dpr);
}
resizeCanvas();

// ğŸš¶ ç§»å‹•å¯èƒ½åˆ¤å®š
function walkable(x, y) {
  if (x < 0 || x >= map[0].length || y < 0 || y >= map.length) return false;
  const cell = map[y][x];
  return cell !== "#" && cell !== "T" && cell !== "W" && cell !== "N";
}

// â–¶ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆæœŸåŒ–
... ï¼ˆæ®‹ã‚Š 270 è¡Œï¼‰
æŠ˜ã‚ŠãŸãŸã¿
message.txt
13 KB
// ã‚´ãƒ¼ãƒ«åˆ¤å®š
export function checkGoal(GRID, x, y) {
  return GRID[y] && GRID[y][x] === "G";
}

// ãƒãƒ¼ãƒãƒ«ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°
export function triggerNormalEnding(state) {
  const { setStatus, bgm, endingRef, setGameCleared } = state  {};
  if (bgm && typeof bgm.pause === "function") bgm.pause();
  if (typeof setStatus === "function") {
    setStatus("ğŸ‰ ãƒãƒ¼ãƒãƒ«ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼ã‚´ãƒ¼ãƒ«ã«åˆ°é”ã—ã¾ã—ãŸï¼");
  }
  if (endingRef) endingRef.value = "normal";
  if (typeof setGameCleared === "function") setGameCleared(true);
}

// ç‰¹æ®Šã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆæ•µã‚’å…¨æ»…ã•ã›ãŸå ´åˆï¼‰
export function triggerSpecialEnding(state) {
  const { setStatus, bgm, endingRef, setGameCleared } = state  {};
  if (bgm && typeof bgm.pause === "function") bgm.pause();
  if (typeof setStatus === "function") {
    setStatus("âœ¨ ç‰¹æ®Šã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼æ•µã‚’å…¨æ»…ã•ã›ã€ä½æ¸¡ã‚’é®ã‚ã¾ã—ãŸï¼");
  }
  if (endingRef) endingRef.value = "special";
  if (typeof setGameCleared === "function") setGameCleared(true);
}

// æ¬¡ã®ãƒãƒƒãƒ—ã¸é€²ã‚€å‡¦ç†
export function nextMap(state) {
  const { MAPS, currentMapIndexRef, setStatus, reloadMap } = state;

  if (currentMapIndexRef.value + 1 < MAPS.length) {
    // æ¬¡ãƒãƒƒãƒ—ã¸
    currentMapIndexRef.value++;

    if (typeof reloadMap === "function") reloadMap();
    if (typeof setStatus === "function") {
      setStatus(ğŸŒ ãƒãƒƒãƒ— ${currentMapIndexRef.value + 1} ã«ç§»å‹•ï¼);
    }
  } else {
    // æœ€çµ‚ãƒãƒƒãƒ—ã‚’è¶…ãˆãŸ â†’ ãƒãƒ¼ãƒãƒ«ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã«ç§»è¡Œ
    triggerNormalEnding(state);
  }
}

// ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®š
export function checkGameOver(player, setStatus) {
  if (player.hearts <= 0) {
    if (typeof setStatus === "function") {
      setStatus("ğŸ’€ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼");
    }
    return true;
  }
  return false;
}
ï»¿
import { maps, tile } from "./map.js";
import { player, initPlayer, takeDamage, updatePlayer, drawLifeGauge, heal } from "./player.js";
import { initEnemies, updateEnemies, drawEnemies, removeEnemy, enemies } from "./enemy.js";
import { checkGoal, checkGameOver } from "./ending.js";
import { startEggGame } from "./eggGame.js";
import { startFishingGame } from "./fishingGame.js";
import { startNiigataQuiz } from "./niigataquiz.js";          // ğŸ¸ ã‚«ã‚¨ãƒ«ç”¨
import { startNiigataHardQuiz } from "./startNiigataHardQuiz.js"; // ğŸ¦ ã‚¢ãƒ©ã‚¤ã‚°ãƒç”¨

// ğŸ® ã‚­ãƒ£ãƒ³ãƒã‚¹è¨­å®š
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
ctx.imageSmoothingEnabled = false;

// ğŸ“¢ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
const statusEl = document.getElementById("messageBox");
function setStatus(msg) {
  if (statusEl) statusEl.textContent = msg;
  console.log(msg);
}

// ğŸµ BGM
const bgm = document.getElementById("bgm");

// ğŸ¨ ç”»åƒç®¡ç†
const images = {
  floor: new Image(),
  wall: new Image(),
  wallSpecial: new Image(),
  enemy: new Image(),
  enemy2: new Image(),
  enemy3: new Image(), // ã‚¢ãƒ©ã‚¤ã‚°ãƒ
  item: new Image(),
  ally: new Image(),
  allyFishing: new Image(),
  goal: new Image(),
  goalEntrance: new Image(),
  entrance: new Image(),
  mahouzin: new Image(),
  floorSpecial: new Image(),
  pl: new Image(),
  heart: new Image(),
  bridge: new Image(),
  tree: new Image(),
  clear: new Image(),
  over: new Image(),
  sadometu: new Image()
};

// ğŸ–¼ ç”»åƒèª­ã¿è¾¼ã¿
images.floor.src = "./assets/images/tanbo3.png";
images.wall.src = "./assets/images/mizu_big.png";
images.wallSpecial.src = "./assets/images/isikabe.png";
images.enemy.src = "./assets/images/enemy.png";
images.enemy2.src = "./assets/images/kaeru.png";
images.enemy3.src = "./assets/images/araiguma.png"; // ğŸ¦ ã‚¢ãƒ©ã‚¤ã‚°ãƒ
images.item.src = "./assets/images/komebukuro.png";
images.ally.src = "./assets/images/murabitopng.png";
images.allyFishing.src = "./assets/images/turibito.png";
images.goal.src = "./assets/images/kakasi2.png";
images.goalEntrance.src = "./assets/images/koudouiriguti.png";
images.entrance.src = "./assets/images/kintin.png";
images.mahouzin.src = "./assets/images/mahouzin.png";
images.floorSpecial.src = "./assets/images/tikakoudouyuka.png";
images.pl.src = "./assets/images/noumin.png";
images.heart.src = "./assets/images/ha-to.png";
images.bridge.src = "./assets/images/hasihasii.png";
images.tree.src = "./assets/images/kinokabe.png";
images.clear.src = "./assets/images/clear.png";
images.over.src = "./assets/images/over.png";
images.sadometu.src = "./assets/images/sadometu.png";

// ğŸŒ ã‚²ãƒ¼ãƒ çŠ¶æ…‹
let currentMapIndex = 0;
let map = maps[currentMapIndex].map(row => [...row]);
let nearAlly = false;
let nearFishingAlly = false;
let gameCleared = false;
let gameOver = false;

// ğŸ–¼ ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒªã‚µã‚¤ã‚º
const dpr = window.devicePixelRatio || 1;
function resizeCanvas() {
  canvas.width = map[0].length * tile * dpr;
  canvas.height = map.length * tile * dpr;
  canvas.style.width = map[0].length * tile + "px";
  canvas.style.height = map.length * tile + "px";
  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.scale(dpr, dpr);
}
resizeCanvas();

// ğŸš¶ ç§»å‹•å¯èƒ½åˆ¤å®š
function walkable(x, y) {
  if (x < 0 || x >= map[0].length || y < 0 || y >= map.length) return false;
  const cell = map[y][x];
  return cell !== "#" && cell !== "T" && cell !== "W" && cell !== "N";
}

// â–¶ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆæœŸåŒ–
function resetPlayer() {
  initPlayer(map);
  player.hearts = player.maxHearts;
  player.invincibleTime = 0;
}

// â¡ æ¬¡ãƒãƒƒãƒ—ã¸
function nextMap() {
  if (currentMapIndex + 1 >= maps.length) {
    setStatus("ğŸ‰ å…¨ã‚¯ãƒªã‚¢ï¼ï¼");
    if (bgm) bgm.pause();
    gameCleared = true;
    return;
  }

  currentMapIndex++;
  map = maps[currentMapIndex].map(row => [...row]);
  resetPlayer();
  initEnemies(map);
  resizeCanvas();

  // ãƒãƒƒãƒ—ã”ã¨ã®å°‚ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  switch (currentMapIndex) {
    case 0:
      setStatus("ğŸŒ¾ ãƒãƒƒãƒ—1ï¼šç”°ã‚“ã¼ã‚¨ãƒªã‚¢ã«åˆ°ç€ï¼");
      break;
    case 1:
      setStatus("ğŸŒŠ ãƒãƒƒãƒ—2ï¼šä¿¡æ¿ƒå·ã®æµåŸŸã«çªå…¥ï¼");
      break;
    case 2:
      setStatus("ğŸ” ãƒãƒƒãƒ—3ï¼šå±±é–“éƒ¨ã®é‡Œã«å…¥ã£ãŸï¼");
      break;
    case 3:
      setStatus("â› ãƒãƒƒãƒ—4ï¼šä½æ¸¡é‡‘å±±ã®åœ°ä¸‹å‘é“ã«æ½œå…¥ï¼");
      break;
    default:
      setStatus(`â¡ ãƒãƒƒãƒ—${currentMapIndex + 1} ã¸é€²ã‚“ã ï¼`);
  }
}

// ğŸ‘¤ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç«‹ã£ã¦ã„ã‚‹ã‚¿ã‚¤ãƒ«åˆ¤å®š
function onTile(x, y) {
  const cell = map[y][x];
  nearAlly = cell === "A";
  nearFishingAlly = cell === "S";

  if (nearAlly) setStatus("ğŸ¤ æ‘äººãŒã„ã‚‹ï¼Enterã§è©±ã—ã‹ã‘ã¦ãã ã•ã„");
  if (nearFishingAlly) setStatus("ğŸ£ é‡£ã‚Šå¥½ãã®æ‘äººãŒã„ã‚‹ï¼Enterã§è©±ã—ã‹ã‘ã¦ãã ã•ã„");
}

// ğŸ†• æ•µå…¨æ»…ãƒã‚§ãƒƒã‚¯
function checkAllEnemiesCleared() {
  if (currentMapIndex === 3 && enemies.length === 0 && !gameCleared && !gameOver) {
    setStatus("ğŸ‰ æ•µã‚’å…¨æ»…ã•ã›ã€ä½æ¸¡ã‚’é®ã‚ã¾ã—ãŸï¼");
    if (bgm) bgm.pause();
    gameCleared = true;
  }
}

// âŒ¨ï¸ ã‚­ãƒ¼æ“ä½œ
document.addEventListener("keydown", (e) => {
  if (gameCleared || gameOver) return;

  let nx = player.x, ny = player.y;
  if (e.key === "ArrowUp") ny--;
  else if (e.key === "ArrowDown") ny++;
  else if (e.key === "ArrowLeft") nx--;
  else if (e.key === "ArrowRight") nx++;
  else if (e.key === "Enter" && nearAlly) {
    setStatus("ğŸ’¬ æ‘äººã€ç”°ã‚“ã¼ã‚’è’ã‚‰ã™ã‚¸ãƒ£ãƒ³ãƒœã‚¿ãƒ‹ã‚·ã®åµã‚’ã¤ã¶ã—ã¦ãã‚Œï¼ã€");
    setTimeout(() => {
      startEggGame((score) => {
        if (score >= 10) heal(1, setStatus);
        setStatus(score >= 10 ? `ğŸ¥š åµã‚’å¤§é‡ã«ã¤ã¶ã—ãŸï¼HPå›å¾©ï¼` : `ğŸ¥š åµã¤ã¶ã—ã‚¹ã‚³ã‚¢: ${score}`);
      });
      map[player.y][player.x] = "0";
      nearAlly = false;
    }, 1500);
    return;
  }
  else if (e.key === "Enter" && nearFishingAlly) {
    setStatus("ğŸ’¬ æ‘äººã€ä¿¡æ¿ƒå·ã®å¤–æ¥é­šã‚’é‡£ã£ã¦é€€æ²»ã—ã¦ãã‚Œï¼ã€");
    setTimeout(() => {
      startFishingGame((score) => {
        if (score >= 10) heal(1, setStatus);
        else if (score <= 0) takeDamage(1, setStatus);
        setStatus(score >= 10 ? `ğŸŸ ãƒ–ãƒ©ãƒƒã‚¯ãƒã‚¹ã‚’ ${score} åŒ¹é‡£ã£ãŸï¼HPå›å¾©ï¼`
                  : score <= 0 ? `âŒ ãƒ–ãƒ©ãƒƒã‚¯ãƒã‚¹ãŒå°‘ãªã™ãã‚‹â€¦å¤–é“ã°ã‹ã‚Šï¼HPæ¸›å°‘`
                  : `ğŸ£ é‡£æœ: ãƒ–ãƒ©ãƒƒã‚¯ãƒã‚¹ ${score}åŒ¹`);
      });
      map[player.y][player.x] = "0";
      nearFishingAlly = false;
    }, 1500);
    return;
  } else return;

  if (walkable(nx, ny)) {
    player.x = nx;
    player.y = ny;

    if (checkGoal(map, player.x, player.y)) {
      setStatus("ğŸ ã‚´ãƒ¼ãƒ«ï¼");
      nextMap();
      return; // âœ… ã“ã“ã§çµ‚äº†ã—ãªã„ã¨åŒã˜ãƒãƒƒãƒ—ã§å†å‡¦ç†ã•ã‚Œã‚‹
    }
    onTile(nx, ny);

    if (map[player.y][player.x] === "I") {
      heal(1, setStatus);
      setStatus("ğŸ™ ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–ã£ãŸï¼HPå›å¾©ï¼");
      map[player.y][player.x] = "0";
    }
  }

  // æ•µã¨ã®æ¥è§¦å‡¦ç†
 updateEnemies(walkable, player, (amt, enemyIndex, type) => {
  if (type === "normal") {
    takeDamage(amt, setStatus);
    removeEnemy(enemyIndex);
  } else if (type === "frog") {
    setStatus("ğŸ¸ ã‚«ã‚¨ãƒ«ã«é­é‡ï¼æ–°æ½Ÿã‚¯ã‚¤ã‚ºã«æŒ‘æˆ¦ï¼");
    startNiigataQuiz((correct) => {
      if (correct) heal(1, setStatus);
      else takeDamage(1, setStatus);
      setStatus(correct ? "â­• æ­£è§£ï¼HPå›å¾©ï¼" : "âŒ ä¸æ­£è§£ï¼HPæ¸›å°‘");
      removeEnemy(enemyIndex);
      checkAllEnemiesCleared();
    });
  } else if (type === "araiteki") {
    setStatus("ğŸ¦ ã‚¢ãƒ©ã‚¤ã‚°ãƒã«é­é‡ï¼é«˜é›£æ˜“åº¦ã‚¯ã‚¤ã‚ºã«æŒ‘æˆ¦ï¼");
    startNiigataHardQuiz((correct) => {
      if (correct) heal(1, setStatus);
      else takeDamage(1, setStatus);
      setStatus(correct ? "â­• æ­£è§£ï¼HPå›å¾©ï¼" : "âŒ ä¸æ­£è§£ï¼HPæ¸›å°‘");
      removeEnemy(enemyIndex);
      checkAllEnemiesCleared();
    });
  }
  checkAllEnemiesCleared();
});

  if (checkGameOver(player, setStatus)) {
    if (bgm) bgm.pause();
    gameOver = true;
    return;
  }
});

// â–¶ ãƒªã‚¹ã‚¿ãƒ¼ãƒˆå‡¦ç†
function restartGame() {
  currentMapIndex = 0;
  map = maps[currentMapIndex].map(row => [...row]);
  resetPlayer();
  initEnemies(map);
  resizeCanvas();
  setStatus("ğŸ”„ ã‚²ãƒ¼ãƒ å†ã‚¹ã‚¿ãƒ¼ãƒˆï¼");
  gameCleared = false;
  gameOver = false;
  if (bgm) {
    bgm.currentTime = 0;
    bgm.play().catch(()=>{});
  }
  draw();
}

// ğŸ¨ æç”»
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (gameCleared) {
    ctx.drawImage(images.sadometu, 0, 0, canvas.width / dpr, canvas.height / dpr);
    ctx.font = "40px sans-serif";
    ctx.fillStyle = "#fff";
    ctx.textAlign = "center";
    ctx.fillText("ğŸ‰ ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼", canvas.width / dpr / 2, 50);
    return;
  }

  if (gameOver) {
    ctx.drawImage(images.over, 0, 0, canvas.width / dpr, canvas.height / dpr);
    const btnW = 200, btnH = 50;
    const btnX = (canvas.width / dpr - btnW) / 2;
    const btnY = canvas.height / dpr * 0.7;
    ctx.fillStyle = "rgba(0,0,0,0.7)";
    ctx.fillRect(btnX, btnY, btnW, btnH);
    ctx.fillStyle = "#fff";
    ctx.font = "20px sans-serif";
    ctx.textAlign = "center";
    ctx.fillText("Restart", btnX + btnW/2, btnY + 32);
    return;
  }

  for (let y = 0; y < map.length; y++) {
    for (let x = 0; x < map[0].length; x++) {
      const dx = x * tile;
      const dy = y * tile;
      const cell = map[y][x];

     // ğŸ†• åºŠã®åˆ‡ã‚Šæ›¿ãˆï¼ˆK,X,Eï¼‰
      if (cell === "K") {
        ctx.drawImage(images.floorSpecial, dx, dy, tile, tile); // åœ°ä¸‹é€šè·¯åºŠ
      } else if (cell === "X") {
        ctx.drawImage(images.floorSpecial, dx, dy, tile, tile);
      } else if (cell === "W") {
        // ğŸŸ é­šã®ã„ã‚‹ãƒã‚¹ã®åºŠã¯æ°´é¢ã«å¤‰æ›´
        ctx.drawImage(images.wall, dx, dy, tile, tile); 
      } else {
        ctx.drawImage(images.floor, dx, dy, tile, tile);
      }
      
      if (cell === "#") ctx.drawImage(images.wall, dx, dy, tile, tile);
      if (cell === "W") ctx.drawImage(images.wallSpecial, dx, dy, tile, tile);
      if (cell === "I") ctx.drawImage(images.item, dx, dy, tile, tile);
      if (cell === "A") ctx.drawImage(images.ally, dx, dy, tile, tile);
      if (cell === "S") ctx.drawImage(images.allyFishing, dx, dy, tile, tile);
      if (cell === "G") {
        if (currentMapIndex === 3) ctx.drawImage(images.mahouzin, dx, dy, tile, tile);
        else ctx.drawImage(images.goal, dx, dy, tile, tile);
      }
      if (cell === "E") ctx.drawImage(images.enemy, dx, dy, tile, tile);
      if (cell === "F") ctx.drawImage(images.enemy2, dx, dy, tile, tile);
      if (cell === "H") ctx.drawImage(images.enemy3, dx, dy, tile, tile); // ğŸ¦ ã‚¢ãƒ©ã‚¤ã‚°ãƒ
      if (cell === "B") ctx.drawImage(images.bridge, dx, dy, tile, tile);
      if (cell === "T") ctx.drawImage(images.tree, dx, dy, tile, tile);
      if (cell === "M") ctx.drawImage(images.mahouzin, dx, dy, tile, tile);
      if (cell === "N") ctx.drawImage(images.entrance, dx, dy, tile, tile);
      if (cell === "O") ctx.drawImage(images.goalEntrance, dx, dy, tile, tile);
    }
  }

  drawEnemies(ctx, images.enemy, images.enemy2, images.enemy3, tile, 0, 0, map[0].length * tile, map.length * tile);
  ctx.drawImage(images.pl, player.x * tile, player.y * tile, tile, tile);
  drawLifeGauge(ctx, images.heart, tile, player);

  updatePlayer();
  requestAnimationFrame(draw);
}

// ğŸ–± Restart ãƒœã‚¿ãƒ³å‡¦ç†
canvas.addEventListener("click", (e) => {
  if (!gameOver) return;
  const rect = canvas.getBoundingClientRect();
  const x = (e.clientX - rect.left) * dpr;
  const y = (e.clientY - rect.top) * dpr;
  const btnW = 200, btnH = 50;
  const btnX = (canvas.width / dpr - btnW) / 2 * dpr;
  const btnY = canvas.height * 0.7;
  if (x >= btnX && x <= btnX+btnW*dpr && y >= btnY && y <= btnY+btnH*dpr) {
    restartGame();
  }
});

// â–¶ ã‚²ãƒ¼ãƒ é–‹å§‹
window.startGame = function () {
  currentMapIndex = 0;
  map = maps[currentMapIndex].map(row => [...row]);
  resetPlayer();
  initEnemies(map);
  resizeCanvas();

  // ã‚²ãƒ¼ãƒ é–‹å§‹å°‚ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  setStatus("ğŸŒ¾ ãƒãƒƒãƒ—1ï¼šç”°ã‚“ã¼ã‚¨ãƒªã‚¢ã«åˆ°ç€ï¼");

  if (bgm) {
    bgm.volume = 0.5;
    bgm.play().catch(err => console.log("BGMå†ç”Ÿã‚¨ãƒ©ãƒ¼:", err));
  }
  draw();
};
